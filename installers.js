"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.installCoreRemover = exports.testCoreRemover = exports.installInSlimModLoader = exports.testInSlimModLoader = exports.installVBuildMod = exports.testVBuild = void 0;
const bluebird_1 = __importDefault(require("bluebird"));
const path_1 = __importDefault(require("path"));
const common_1 = require("./common");
const INVALID_DIRS = ['core', 'valheim_data'];
const INVALID_FILES = [common_1.DOORSTOPPER_HOOK].concat(common_1.IGNORABLE_FILES).map(file => file.toLowerCase());
function isInvalidSegment(filePathSegment, invalidCollection) {
    return invalidCollection.includes(filePathSegment);
}
function testVBuild(files, gameId) {
    if (gameId !== common_1.GAME_ID) {
        return bluebird_1.default.resolve({ supported: false, requiredFiles: [] });
    }
    const supported = files.find(file => path_1.default.extname(file) === common_1.VBUILD_EXT) !== undefined;
    return bluebird_1.default.resolve({ supported, requiredFiles: [] });
}
exports.testVBuild = testVBuild;
function installVBuildMod(files, destinationPath, gameId) {
    const filtered = files.filter(file => path_1.default.extname(file) === common_1.VBUILD_EXT);
    const instructions = filtered.map(file => ({
        type: 'copy',
        source: file,
        destination: path_1.default.basename(file),
    }));
    return bluebird_1.default.resolve({ instructions });
}
exports.installVBuildMod = installVBuildMod;
function testInSlimModLoader(files, gameId) {
    if (gameId !== common_1.GAME_ID) {
        return bluebird_1.default.resolve({ supported: false, requiredFiles: [] });
    }
    const supported = files.find(file => path_1.default.basename(file) === common_1.INSLIMVML_IDENTIFIER) !== undefined;
    return bluebird_1.default.resolve({ supported, requiredFiles: [] });
}
exports.testInSlimModLoader = testInSlimModLoader;
function installInSlimModLoader(files, destinationPath, gameId) {
    const identifier = files.find(file => path_1.default.basename(file) === common_1.INSLIMVML_IDENTIFIER);
    const minSegIdx = identifier.split(path_1.default.sep).indexOf(common_1.INSLIMVML_IDENTIFIER);
    const instructions = files.reduce((accum, file) => {
        const segments = file.split(path_1.default.sep).filter(seg => !!seg);
        if (!path_1.default.extname(segments[segments.length - 1])) {
            return accum;
        }
        const destination = (segments.length >= minSegIdx + 1)
            ? segments.slice(minSegIdx).join(path_1.default.sep)
            : undefined;
        if (destination !== undefined) {
            accum.push({
                type: 'copy',
                source: file,
                destination,
            });
        }
        return accum;
    }, []);
    return bluebird_1.default.resolve({ instructions });
}
exports.installInSlimModLoader = installInSlimModLoader;
function testCoreRemover(files, gameId) {
    if (gameId !== common_1.GAME_ID) {
        return bluebird_1.default.resolve({ supported: false, requiredFiles: [] });
    }
    let supported = false;
    for (const file of files) {
        const segments = file.split(path_1.default.sep).map(seg => seg.toLowerCase());
        if ((segments.find(seg => isInvalidSegment(seg, INVALID_DIRS)) !== undefined)
            && (isInvalidSegment(segments[segments.length - 1], INVALID_FILES))) {
            supported = true;
            break;
        }
    }
    return bluebird_1.default.resolve({ supported, requiredFiles: [] });
}
exports.testCoreRemover = testCoreRemover;
function installCoreRemover(files, destinationPath, gameId) {
    let minSegIdx = 0;
    for (const file of files) {
        const segments = file.split(path_1.default.sep)
            .filter(seg => !!seg)
            .map(seg => seg.toLowerCase());
        if (segments.includes('plugins')) {
            minSegIdx = segments.indexOf('plugins');
            break;
        }
        if (segments.includes('patchers')) {
            minSegIdx = segments.indexOf('patchers');
            break;
        }
    }
    const instructions = files.reduce((accum, iter) => {
        const segments = iter.split(path_1.default.sep).filter(seg => !!seg);
        if (!segments.find(seg => isInvalidSegment(seg.toLowerCase(), INVALID_DIRS))
            && (!isInvalidSegment(segments[segments.length - 1].toLowerCase(), INVALID_FILES))
            && !!path_1.default.extname(segments[segments.length - 1])) {
            const destination = (segments.length > minSegIdx + 1)
                ? segments.slice(minSegIdx).join(path_1.default.sep)
                : undefined;
            if (destination !== undefined) {
                const instr = {
                    type: 'copy',
                    source: iter,
                    destination,
                };
                accum.push(instr);
            }
        }
        return accum;
    }, []);
    return bluebird_1.default.resolve({ instructions });
}
exports.installCoreRemover = installCoreRemover;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5zdGFsbGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImluc3RhbGxlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsd0RBQStCO0FBQy9CLGdEQUF3QjtBQUd4QixxQ0FDcUQ7QUFHckQsTUFBTSxZQUFZLEdBQUcsQ0FBQyxNQUFNLEVBQUUsY0FBYyxDQUFDLENBQUM7QUFDOUMsTUFBTSxhQUFhLEdBQUcsQ0FBQyx5QkFBZ0IsQ0FBQyxDQUFDLE1BQU0sQ0FBQyx3QkFBZSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7QUFFakcsU0FBUyxnQkFBZ0IsQ0FBQyxlQUF1QixFQUFFLGlCQUEyQjtJQUM1RSxPQUFPLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUNyRCxDQUFDO0FBRUQsU0FBZ0IsVUFBVSxDQUFDLEtBQWUsRUFBRSxNQUFjO0lBQ3hELElBQUksTUFBTSxLQUFLLGdCQUFPLEVBQUU7UUFDdEIsT0FBTyxrQkFBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsYUFBYSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7S0FDakU7SUFFRCxNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsY0FBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxtQkFBVSxDQUFDLEtBQUssU0FBUyxDQUFDO0lBQ3RGLE9BQU8sa0JBQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDM0QsQ0FBQztBQVBELGdDQU9DO0FBRUQsU0FBZ0IsZ0JBQWdCLENBQUMsS0FBZSxFQUFFLGVBQXVCLEVBQUUsTUFBYztJQUN2RixNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLElB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QUssU0FBUyxFQUFFO2dCQUM3QixNQUFNLEtBQUssR0FBdUI7b0JBQ2hDLElBQUksRUFBRSxNQUFNO29CQUNaLE1BQU0sRUFBRSxJQUFJO29CQUNaLFdBQVc7aUJBQ1osQ0FBQztnQkFDRixLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ25CO1NBQ0o7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUVQLE9BQU8sa0JBQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO0FBQzNDLENBQUM7QUExQ0QsZ0RBMENDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnO1xyXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcclxuXHJcbmltcG9ydCB7IHR5cGVzIH0gZnJvbSAndm9ydGV4LWFwaSc7XHJcbmltcG9ydCB7IERPT1JTVE9QUEVSX0hPT0ssIEdBTUVfSUQsIElHTk9SQUJMRV9GSUxFUyxcclxuICBJTlNMSU1WTUxfSURFTlRJRklFUiwgVkJVSUxEX0VYVCB9IGZyb20gJy4vY29tbW9uJztcclxuXHJcbi8vIFRoZXNlIGFyZSBkaXJlY3RvcmllcyB3ZVxyXG5jb25zdCBJTlZBTElEX0RJUlMgPSBbJ2NvcmUnLCAndmFsaGVpbV9kYXRhJ107XHJcbmNvbnN0IElOVkFMSURfRklMRVMgPSBbRE9PUlNUT1BQRVJfSE9PS10uY29uY2F0KElHTk9SQUJMRV9GSUxFUykubWFwKGZpbGUgPT4gZmlsZS50b0xvd2VyQ2FzZSgpKTtcclxuXHJcbmZ1bmN0aW9uIGlzSW52YWxpZFNlZ21lbnQoZmlsZVBhdGhTZWdtZW50OiBzdHJpbmcsIGludmFsaWRDb2xsZWN0aW9uOiBzdHJpbmdbXSkge1xyXG4gIHJldHVybiBpbnZhbGlkQ29sbGVjdGlvbi5pbmNsdWRlcyhmaWxlUGF0aFNlZ21lbnQpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdGVzdFZCdWlsZChmaWxlczogc3RyaW5nW10sIGdhbWVJZDogc3RyaW5nKTogUHJvbWlzZTx0eXBlcy5JU3VwcG9ydGVkUmVzdWx0PiB7XHJcbiAgaWYgKGdhbWVJZCAhPT0gR0FNRV9JRCkge1xyXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN1cHBvcnRlZDogZmFsc2UsIHJlcXVpcmVkRmlsZXM6IFtdIH0pO1xyXG4gIH1cclxuXHJcbiAgY29uc3Qgc3VwcG9ydGVkID0gZmlsZXMuZmluZChmaWxlID0+IHBhdGguZXh0bmFtZShmaWxlKSA9PT0gVkJVSUxEX0VYVCkgIT09IHVuZGVmaW5lZDtcclxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3VwcG9ydGVkLCByZXF1aXJlZEZpbGVzOiBbXSB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGluc3RhbGxWQnVpbGRNb2QoZmlsZXM6IHN0cmluZ1tdLCBkZXN0aW5hdGlvblBhdGg6IHN0cmluZywgZ2FtZUlkOiBzdHJpbmcpIHtcclxuICBjb25zdCBmaWx0ZXJlZCA9IGZpbGVzLmZpbHRlcihmaWxlID0+IHBhdGguZXh0bmFtZShmaWxlKSA9PT0gVkJVSUxEX0VYVCk7XHJcbiAgY29uc3QgaW5zdHJ1Y3Rpb25zOiB0eXBlcy5JSW5zdHJ1Y3Rpb25bXSA9IGZpbHRlcmVkLm1hcChmaWxlID0+ICh7XHJcbiAgICB0eXBlOiAnY29weScsXHJcbiAgICBzb3VyY2U6IGZpbGUsXHJcbiAgICBkZXN0aW5hdGlvbjogcGF0aC5iYXNlbmFtZShmaWxlKSxcclxuICB9KSk7XHJcblxyXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBpbnN0cnVjdGlvbnMgfSk7XHJcbn1cclxuXHJcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbWF4LWxpbmUtbGVuZ3RoXHJcbmV4cG9ydCBmdW5jdGlvbiB0ZXN0SW5TbGltTW9kTG9hZGVyKGZpbGVzOiBzdHJpbmdbXSwgZ2FtZUlkOiBzdHJpbmcpOiBQcm9taXNlPHR5cGVzLklTdXBwb3J0ZWRSZXN1bHQ+IHtcclxuICBpZiAoZ2FtZUlkICE9PSBHQU1FX0lEKSB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3VwcG9ydGVkOiBmYWxzZSwgcmVxdWlyZWRGaWxlczogW10gfSk7XHJcbiAgfVxyXG5cclxuICBjb25zdCBzdXBwb3J0ZWQgPSBmaWxlcy5maW5kKGZpbGUgPT4gcGF0aC5iYXNlbmFtZShmaWxlKSA9PT0gSU5TTElNVk1MX0lERU5USUZJRVIpICE9PSB1bmRlZmluZWQ7XHJcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN1cHBvcnRlZCwgcmVxdWlyZWRGaWxlczogW10gfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbnN0YWxsSW5TbGltTW9kTG9hZGVyKGZpbGVzOiBzdHJpbmdbXSwgZGVzdGluYXRpb25QYXRoOiBzdHJpbmcsIGdhbWVJZDogc3RyaW5nKSB7XHJcbiAgLy8gVGhpcyBnYW1lIGV4dGVuc2lvbiBjb21lcyB3aXRoIHRoZSBJblNsaW1WTUwgdW5pdHkgZG9vciBzdG9wcGVyIGFzc2VtYmx5IGJ5IGRlZmF1bHQsIG5vIHBvaW50XHJcbiAgLy8gIGluIGFkZGluZyBpdC5cclxuICBjb25zdCBpZGVudGlmaWVyID0gZmlsZXMuZmluZChmaWxlID0+IHBhdGguYmFzZW5hbWUoZmlsZSkgPT09IElOU0xJTVZNTF9JREVOVElGSUVSKTtcclxuICBjb25zdCBtaW5TZWdJZHggPSBpZGVudGlmaWVyLnNwbGl0KHBhdGguc2VwKS5pbmRleE9mKElOU0xJTVZNTF9JREVOVElGSUVSKTtcclxuICBjb25zdCBpbnN0cnVjdGlvbnM6IHR5cGVzLklJbnN0cnVjdGlvbltdID0gZmlsZXMucmVkdWNlKChhY2N1bSwgZmlsZSkgPT4ge1xyXG4gICAgY29uc3Qgc2VnbWVudHMgPSBmaWxlLnNwbGl0KHBhdGguc2VwKS5maWx0ZXIoc2VnID0+ICEhc2VnKTtcclxuICAgIGlmICghcGF0aC5leHRuYW1lKHNlZ21lbnRzW3NlZ21lbnRzLmxlbmd0aCAtIDFdKSkge1xyXG4gICAgICAvLyBUaGlzIGlzIGEgZGlyZWN0b3J5LCB3ZSBkb24ndCBuZWVkIGl0LlxyXG4gICAgICByZXR1cm4gYWNjdW07XHJcbiAgICB9XHJcbiAgICBjb25zdCBkZXN0aW5hdGlvbiA9IChzZWdtZW50cy5sZW5ndGggPj0gbWluU2VnSWR4ICsgMSlcclxuICAgICAgPyBzZWdtZW50cy5zbGljZShtaW5TZWdJZHgpLmpvaW4ocGF0aC5zZXApXHJcbiAgICAgIDogdW5kZWZpbmVkO1xyXG4gICAgaWYgKGRlc3RpbmF0aW9uICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgYWNjdW0ucHVzaCh7XHJcbiAgICAgICAgdHlwZTogJ2NvcHknLFxyXG4gICAgICAgIHNvdXJjZTogZmlsZSxcclxuICAgICAgICBkZXN0aW5hdGlvbixcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYWNjdW07XHJcbiAgfSwgW10pO1xyXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBpbnN0cnVjdGlvbnMgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB0ZXN0Q29yZVJlbW92ZXIoZmlsZXM6IHN0cmluZ1tdLCBnYW1lSWQ6IHN0cmluZyk6IFByb21pc2U8dHlwZXMuSVN1cHBvcnRlZFJlc3VsdD4ge1xyXG4gIGlmIChnYW1lSWQgIT09IEdBTUVfSUQpIHtcclxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdXBwb3J0ZWQ6IGZhbHNlLCByZXF1aXJlZEZpbGVzOiBbXSB9KTtcclxuICB9XHJcbiAgbGV0IHN1cHBvcnRlZCA9IGZhbHNlO1xyXG4gIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xyXG4gICAgY29uc3Qgc2VnbWVudHMgPSBmaWxlLnNwbGl0KHBhdGguc2VwKS5tYXAoc2VnID0+IHNlZy50b0xvd2VyQ2FzZSgpKTtcclxuICAgIGlmICgoc2VnbWVudHMuZmluZChzZWcgPT4gaXNJbnZhbGlkU2VnbWVudChzZWcsIElOVkFMSURfRElSUykpICE9PSB1bmRlZmluZWQpXHJcbiAgICAgICYmIChpc0ludmFsaWRTZWdtZW50KHNlZ21lbnRzW3NlZ21lbnRzLmxlbmd0aCAtIDFdLCBJTlZBTElEX0ZJTEVTKSkpIHtcclxuICAgICAgICBzdXBwb3J0ZWQgPSB0cnVlO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdXBwb3J0ZWQsIHJlcXVpcmVkRmlsZXM6IFtdIH0pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5zdGFsbENvcmVSZW1vdmVyKGZpbGVzOiBzdHJpbmdbXSwgZGVzdGluYXRpb25QYXRoOiBzdHJpbmcsIGdhbWVJZDogc3RyaW5nKSB7XHJcbiAgLy8gTWFueSBleGlzdGluZyBtb2RzIGhhdmUgQmVwSW5FeCdzIGNvcmUgZGlyZWN0b3J5IHByZS1pbmNsdWRlZCwgd2UgZG8gbm90IHdhbnRcclxuICAvLyAgdGhvc2UgZmlsZXMgaW5zdGFsbGVkIGFzIGl0IHdpbGwganVzdCBjYXVzZSB1bmV4cGVjdGVkIGJlaGF2aW91ci5cclxuICBsZXQgbWluU2VnSWR4ID0gMDtcclxuICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcclxuICAgIGNvbnN0IHNlZ21lbnRzID0gZmlsZS5zcGxpdChwYXRoLnNlcClcclxuICAgICAgLmZpbHRlcihzZWcgPT4gISFzZWcpXHJcbiAgICAgIC5tYXAoc2VnID0+IHNlZy50b0xvd2VyQ2FzZSgpKTtcclxuXHJcbiAgICBpZiAoc2VnbWVudHMuaW5jbHVkZXMoJ3BsdWdpbnMnKSkge1xyXG4gICAgICBtaW5TZWdJZHggPSBzZWdtZW50cy5pbmRleE9mKCdwbHVnaW5zJyk7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gICAgaWYgKHNlZ21lbnRzLmluY2x1ZGVzKCdwYXRjaGVycycpKSB7XHJcbiAgICAgIG1pblNlZ0lkeCA9IHNlZ21lbnRzLmluZGV4T2YoJ3BhdGNoZXJzJyk7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgY29uc3QgaW5zdHJ1Y3Rpb25zOiB0eXBlcy5JSW5zdHJ1Y3Rpb25bXSA9IGZpbGVzLnJlZHVjZSgoYWNjdW0sIGl0ZXIpID0+IHtcclxuICAgIGNvbnN0IHNlZ21lbnRzID0gaXRlci5zcGxpdChwYXRoLnNlcCkuZmlsdGVyKHNlZyA9PiAhIXNlZyk7XHJcblxyXG4gICAgaWYgKCFzZWdtZW50cy5maW5kKHNlZyA9PiBpc0ludmFsaWRTZWdtZW50KHNlZy50b0xvd2VyQ2FzZSgpLCBJTlZBTElEX0RJUlMpKVxyXG4gICAgICAmJiAoIWlzSW52YWxpZFNlZ21lbnQoc2VnbWVudHNbc2VnbWVudHMubGVuZ3RoIC0gMV0udG9Mb3dlckNhc2UoKSwgSU5WQUxJRF9GSUxFUykpXHJcbiAgICAgICYmICEhcGF0aC5leHRuYW1lKHNlZ21lbnRzW3NlZ21lbnRzLmxlbmd0aCAtIDFdKSkge1xyXG4gICAgICAgIGNvbnN0IGRlc3RpbmF0aW9uID0gKHNlZ21lbnRzLmxlbmd0aCA+IG1pblNlZ0lkeCArIDEpXHJcbiAgICAgICAgICA/IHNlZ21lbnRzLnNsaWNlKG1pblNlZ0lkeCkuam9pbihwYXRoLnNlcClcclxuICAgICAgICAgIDogdW5kZWZpbmVkO1xyXG5cclxuICAgICAgICBpZiAoZGVzdGluYXRpb24gIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgY29uc3QgaW5zdHI6IHR5cGVzLklJbnN0cnVjdGlvbiA9IHtcclxuICAgICAgICAgICAgdHlwZTogJ2NvcHknLFxyXG4gICAgICAgICAgICBzb3VyY2U6IGl0ZXIsXHJcbiAgICAgICAgICAgIGRlc3RpbmF0aW9uLFxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIGFjY3VtLnB1c2goaW5zdHIpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBhY2N1bTtcclxuICB9LCBbXSk7XHJcblxyXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBpbnN0cnVjdGlvbnMgfSk7XHJcbn1cclxuIl19