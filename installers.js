"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.installFullPack = exports.testFullPack = exports.installCoreRemover = exports.testCoreRemover = exports.installInSlimModLoader = exports.testInSlimModLoader = exports.installVBuildMod = exports.testVBuild = void 0;
const bluebird_1 = __importDefault(require("bluebird"));
const path_1 = __importDefault(require("path"));
const vortex_api_1 = require("vortex-api");
const common_1 = require("./common");
const INVALID_DIRS = ['core', 'valheim_data'];
const INVALID_FILES = [common_1.DOORSTOPPER_HOOK].concat(common_1.IGNORABLE_FILES).map(file => file.toLowerCase());
const PACK_SEGMENTS = ['core_lib', 'unstripped_corlib'];
function indexOfPackSegment(segments) {
    const hasPackSegment = (seg) => PACK_SEGMENTS.includes(seg);
    const segment = segments.find(hasPackSegment);
    if (segment !== undefined) {
        return segments.indexOf(segment);
    }
    return -1;
}
function getPackType(seg) {
    switch (seg) {
        case 'core_lib':
            return 'core_lib';
        case 'unstripped_corlib':
            return 'unstripped_corlib';
        default:
            return 'none';
    }
}
function isInvalidSegment(filePathSegment, invalidCollection) {
    return invalidCollection.includes(filePathSegment);
}
function testVBuild(files, gameId) {
    if (gameId !== common_1.GAME_ID) {
        return bluebird_1.default.resolve({ supported: false, requiredFiles: [] });
    }
    const supported = files.find(file => path_1.default.extname(file) === common_1.VBUILD_EXT) !== undefined;
    return bluebird_1.default.resolve({ supported, requiredFiles: [] });
}
exports.testVBuild = testVBuild;
function installVBuildMod(files, destinationPath, gameId) {
    const filtered = files.filter(file => path_1.default.extname(file) === common_1.VBUILD_EXT);
    const instructions = filtered.map(file => ({
        type: 'copy',
        source: file,
        destination: path_1.default.basename(file),
    }));
    return bluebird_1.default.resolve({ instructions });
}
exports.installVBuildMod = installVBuildMod;
function testInSlimModLoader(files, gameId) {
    if (gameId !== common_1.GAME_ID) {
        return bluebird_1.default.resolve({ supported: false, requiredFiles: [] });
    }
    const supported = files.find(file => path_1.default.basename(file) === common_1.INSLIMVML_IDENTIFIER) !== undefined;
    return bluebird_1.default.resolve({ supported, requiredFiles: [] });
}
exports.testInSlimModLoader = testInSlimModLoader;
function installInSlimModLoader(files, destinationPath, gameId) {
    const identifier = files.find(file => path_1.default.basename(file) === common_1.INSLIMVML_IDENTIFIER);
    const minSegIdx = identifier.split(path_1.default.sep).indexOf(common_1.INSLIMVML_IDENTIFIER);
    const instructions = files.reduce((accum, file) => {
        const segments = file.split(path_1.default.sep).filter(seg => !!seg);
        if (!path_1.default.extname(segments[segments.length - 1])) {
            return accum;
        }
        const destination = (segments.length >= minSegIdx + 1)
            ? segments.slice(minSegIdx).join(path_1.default.sep)
            : undefined;
        if (destination !== undefined) {
            accum.push({
                type: 'copy',
                source: file,
                destination,
            });
        }
        return accum;
    }, []);
    return bluebird_1.default.resolve({ instructions });
}
exports.installInSlimModLoader = installInSlimModLoader;
function testCoreRemover(files, gameId) {
    if (gameId !== common_1.GAME_ID) {
        return bluebird_1.default.resolve({ supported: false, requiredFiles: [] });
    }
    let supported = false;
    for (const file of files) {
        const segments = file.split(path_1.default.sep).map(seg => seg.toLowerCase());
        if ((segments.find(seg => isInvalidSegment(seg, INVALID_DIRS)) !== undefined)
            && (isInvalidSegment(segments[segments.length - 1], INVALID_FILES))) {
            supported = true;
            break;
        }
    }
    return bluebird_1.default.resolve({ supported, requiredFiles: [] });
}
exports.testCoreRemover = testCoreRemover;
function installCoreRemover(files, destinationPath, gameId) {
    let minSegIdx = 0;
    for (const file of files) {
        const segments = file.split(path_1.default.sep)
            .filter(seg => !!seg)
            .map(seg => seg.toLowerCase());
        if (segments.includes('plugins')) {
            minSegIdx = segments.indexOf('plugins');
            break;
        }
        if (segments.includes('patchers')) {
            minSegIdx = segments.indexOf('patchers');
            break;
        }
    }
    const instructions = files.reduce((accum, iter) => {
        const segments = iter.split(path_1.default.sep).filter(seg => !!seg);
        if (!segments.find(seg => isInvalidSegment(seg.toLowerCase(), INVALID_DIRS))
            && (!isInvalidSegment(segments[segments.length - 1].toLowerCase(), INVALID_FILES))
            && !!path_1.default.extname(segments[segments.length - 1])) {
            const destination = (segments.length > minSegIdx + 1)
                ? segments.slice(minSegIdx).join(path_1.default.sep)
                : undefined;
            if (destination !== undefined) {
                const instr = {
                    type: 'copy',
                    source: iter,
                    destination,
                };
                accum.push(instr);
            }
        }
        return accum;
    }, []);
    return bluebird_1.default.resolve({ instructions });
}
exports.installCoreRemover = installCoreRemover;
function testFullPack(files, gameId) {
    if (gameId !== common_1.GAME_ID) {
        return bluebird_1.default.resolve({ supported: false, requiredFiles: [] });
    }
    let supported = false;
    for (const file of files) {
        const segments = file.split(path_1.default.sep).map(seg => seg.toLowerCase());
        const coreLibIdx = indexOfPackSegment(segments);
        if (coreLibIdx === -1) {
            continue;
        }
        if (coreLibIdx !== undefined) {
            supported = true;
            break;
        }
    }
    return bluebird_1.default.resolve({ supported, requiredFiles: [] });
}
exports.testFullPack = testFullPack;
function installFullPack(files, destinationPath, gameId) {
    let coreLibIdx = -1;
    let packType;
    const filtered = files.filter(file => {
        const segments = file.split(path_1.default.sep).map(seg => seg.toLowerCase());
        if (!path_1.default.extname(segments[segments.length - 1])) {
            return false;
        }
        if (coreLibIdx === -1) {
            coreLibIdx = indexOfPackSegment(segments);
            packType = getPackType(segments[coreLibIdx]);
            if (coreLibIdx !== -1) {
                return true;
            }
        }
        else {
            if (PACK_SEGMENTS.includes(segments[coreLibIdx])) {
                return true;
            }
        }
        return false;
    });
    if (packType === 'none') {
        return bluebird_1.default.reject(new vortex_api_1.util.NotSupportedError());
    }
    const modTypeInstr = (packType === 'core_lib')
        ? {
            type: 'setmodtype',
            value: 'bepinex-root-mod',
        } : {
        type: 'setmodtype',
        value: 'unstripped-assemblies',
    };
    const modAttribInstr = {
        type: 'attribute',
        key: 'CoreLibType',
        value: packType,
    };
    const instructions = [modTypeInstr, modAttribInstr]
        .concat(filtered.map(file => ({
        type: 'copy',
        source: file,
        destination: file.split(path_1.default.sep).slice(coreLibIdx).join(path_1.default.sep),
    })));
    return bluebird_1.default.resolve({ instructions });
}
exports.installFullPack = installFullPack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5zdGFsbGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImluc3RhbGxlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsd0RBQStCO0FBQy9CLGdEQUF3QjtBQUV4QiwyQ0FBeUM7QUFDekMscUNBQytEO0FBRS9ELE1BQU0sWUFBWSxHQUFHLENBQUMsTUFBTSxFQUFFLGNBQWMsQ0FBQyxDQUFDO0FBQzlDLE1BQU0sYUFBYSxHQUFHLENBQUMseUJBQWdCLENBQUMsQ0FBQyxNQUFNLENBQUMsd0JBQWUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO0FBQ2pHLE1BQU0sYUFBYSxHQUFHLENBQUMsVUFBVSxFQUFFLG1CQUFtQixDQUFDLENBQUM7QUFFeEQsU0FBUyxrQkFBa0IsQ0FBQyxRQUFrQjtJQUM1QyxNQUFNLGNBQWMsR0FBRyxDQUFDLEdBQVcsRUFBRSxFQUFFLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNwRSxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQzlDLElBQUksT0FBTyxLQUFLLFNBQVMsRUFBRTtRQUN6QixPQUFPLFFBQVEsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDbEM7SUFDRCxPQUFPLENBQUMsQ0FBQyxDQUFDO0FBQ1osQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLEdBQVc7SUFDOUIsUUFBUSxHQUFHLEVBQUU7UUFDWCxLQUFLLFVBQVU7WUFDYixPQUFPLFVBQVUsQ0FBQztRQUNwQixLQUFLLG1CQUFtQjtZQUN0QixPQUFPLG1CQUFtQixDQUFDO1FBQzdCO1lBQ0UsT0FBTyxNQUFNLENBQUM7S0FDakI7QUFDSCxDQUFDO0FBRUQsU0FBUyxnQkFBZ0IsQ0FBQyxlQUF1QixFQUFFLGlCQUEyQjtJQUM1RSxPQUFPLGlCQUFpQixD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QVcsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLGNBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQUksQ0FBQyxHQUFHLENBQUM7S0FDckUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVMLE9BQU8sa0JBQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO0FBQzNDLENBQUM7QUFoREQsMENBZ0RDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnO1xyXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcclxuXHJcbmltcG9ydCB7IHR5cGVzLCB1dGlsIH0gZnJvbSAndm9ydGV4LWFwaSc7XHJcbmltcG9ydCB7IERPT1JTVE9QUEVSX0hPT0ssIEdBTUVfSUQsIElHTk9SQUJMRV9GSUxFUyxcclxuICBJTlNMSU1WTUxfSURFTlRJRklFUiwgUGFja1R5cGUsIFZCVUlMRF9FWFQgfSBmcm9tICcuL2NvbW1vbic7XHJcblxyXG5jb25zdCBJTlZBTElEX0RJUlMgPSBbJ2NvcmUnLCAndmFsaGVpbV9kYXRhJ107XHJcbmNvbnN0IElOVkFMSURfRklMRVMgPSBbRE9PUlNUT1BQRVJfSE9PS10uY29uY2F0KElHTk9SQUJMRV9GSUxFUykubWFwKGZpbGUgPT4gZmlsZS50b0xvd2VyQ2FzZSgpKTtcclxuY29uc3QgUEFDS19TRUdNRU5UUyA9IFsnY29yZV9saWInLCAndW5zdHJpcHBlZF9jb3JsaWInXTtcclxuXHJcbmZ1bmN0aW9uIGluZGV4T2ZQYWNrU2VnbWVudChzZWdtZW50czogc3RyaW5nW10pIHtcclxuICBjb25zdCBoYXNQYWNrU2VnbWVudCA9IChzZWc6IHN0cmluZykgPT4gUEFDS19TRUdNRU5UUy5pbmNsdWRlcyhzZWcpO1xyXG4gIGNvbnN0IHNlZ21lbnQgPSBzZWdtZW50cy5maW5kKGhhc1BhY2tTZWdtZW50KTtcclxuICBpZiAoc2VnbWVudCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICByZXR1cm4gc2VnbWVudHMuaW5kZXhPZihzZWdtZW50KTtcclxuICB9XHJcbiAgcmV0dXJuIC0xO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRQYWNrVHlwZShzZWc6IHN0cmluZyk6IFBhY2tUeXBlIHtcclxuICBzd2l0Y2ggKHNlZykge1xyXG4gICAgY2FzZSAnY29yZV9saWInOlxyXG4gICAgICByZXR1cm4gJ2NvcmVfbGliJztcclxuICAgIGNhc2UgJ3Vuc3RyaXBwZWRfY29ybGliJzpcclxuICAgICAgcmV0dXJuICd1bnN0cmlwcGVkX2NvcmxpYic7XHJcbiAgICBkZWZhdWx0OlxyXG4gICAgICByZXR1cm4gJ25vbmUnO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaXNJbnZhbGlkU2VnbWVudChmaWxlUGF0aFNlZ21lbnQ6IHN0cmluZywgaW52YWxpZENvbGxlY3Rpb246IHN0cmluZ1tdKSB7XHJcbiAgcmV0dXJuIGludmFsaWRDb2xsZWN0aW9uLmluY2x1ZGVzKGZpbGVQYXRoU2VnbWVudCk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB0ZXN0VkJ1aWxkKGZpbGVzOiBzdHJpbmdbXSwgZ2FtZUlkOiBzdHJpbmcpOiBQcm9taXNlPHR5cGVzLklTdXBwb3J0ZWRSZXN1bHQ+IHtcclxuICBpZiAoZ2FtZUlkICE9PSBHQU1FX0lEKSB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3VwcG9ydGVkOiBmYWxzZSwgcmVxdWlyZWRGaWxlczogW10gfSk7XHJcbiAgfVxyXG5cclxuICBjb25zdCBzdXBwb3J0ZWQgPSBmaWxlcy5maW5kKGZpbGUgPT4gcGF0aC5leHRuYW1lKGZpbGUpID09PSBWQlVJTERfRVhUKSAhPT0gdW5kZWZpbmVkO1xyXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdXBwb3J0ZWQsIHJlcXVpcmVkRmlsZXM6IFtdIH0pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5zdGFsbFZCdWlsZE1vZChmaWxlczogc3RyaW5nW10sIGRlc3RpbmF0aW9uUGF0aDogc3RyaW5nLCBnYW1lSWQ6IHN0cmluZykge1xyXG4gIGNvbnN0IGZpbHRlcmVkID0gZmlsZXMuZmlsdGVyKGZpbGUgPT4gcGF0aC5leHRuYW1lKGZpbGUpID09PSBWQlVJTERfRVhUKTtcclxuICBjb25zdCBpbnN0cnVjdGlvbnM6IHR5cGVzLklJbnN0cnVjdGlvbltdID0gZmlsdGVyZWQubWFwKGZpbGUgPT4gKHtcclxuICAgIHR5cGU6ICdjb3B5JyxcclxuICAgIHNvdXJjZTogZmlsZSxcclxuICAgIGRlc3RpbmF0aW9uOiBwYXRoLmJhc2VuYW1lKGZpbGUpLFxyXG4gIH0pKTtcclxuXHJcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGluc3RydWN0aW9ucyB9KTtcclxufVxyXG5cclxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtYXgtbGluZS1sZW5ndGhcclxuZXhwb3J0IGZ1bmN0aW9uIHRlc3RJblNsaW1Nb2RMb2FkZXIoZmlsZXM6IHN0cmluZ1tdLCBnYW1lSWQ6IHN0cmluZyk6IFByb21pc2U8dHlwZXMuSVN1cHBvcnRlZFJlc3VsdD4ge1xyXG4gIGlmIChnYW1lSWQgIT09IEdBTUVfSUQpIHtcclxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdXBwb3J0ZWQ6IGZhbHNlLCByZXF1aXJlZEZpbGVzOiBbXSB9KTtcclxuICB9XHJcblxyXG4gIGNvbnN0IHN1cHBvcnRlZCA9IGZpbGVzLmZpbmQoZmlsZSA9PiBwYXRoLmJhc2VuYW1lKGZpbGUpID09PSBJTlNMSU1WTUxfSURFTlRJRklFUikgIT09IHVuZGVmaW5lZDtcclxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3VwcG9ydGVkLCByZXF1aXJlZEZpbGVzOiBbXSB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGluc3RhbGxJblNsaW1Nb2RMb2FkZXIoZmlsZXM6IHN0cmluZ1tdLCBkZXN0aW5hdGlvblBhdGg6IHN0cmluZywgZ2FtZUlkOiBzdHJpbmcpIHtcclxuICAvLyBUaGlzIGdhbWUgZXh0ZW5zaW9uIGNvbWVzIHdpdGggdGhlIEluU2xpbVZNTCB1bml0eSBkb29yIHN0b3BwZXIgYXNzZW1ibHkgYnkgZGVmYXVsdCwgbm8gcG9pbnRcclxuICAvLyAgaW4gYWRkaW5nIGl0LlxyXG4gIGNvbnN0IGlkZW50aWZpZXIgPSBmaWxlcy5maW5kKGZpbGUgPT4gcGF0aC5iYXNlbmFtZShmaWxlKSA9PT0gSU5TTElNVk1MX0lERU5USUZJRVIpO1xyXG4gIGNvbnN0IG1pblNlZ0lkeCA9IGlkZW50aWZpZXIuc3BsaXQocGF0aC5zZXApLmluZGV4T2YoSU5TTElNVk1MX0lERU5USUZJRVIpO1xyXG4gIGNvbnN0IGluc3RydWN0aW9uczogdHlwZXMuSUluc3RydWN0aW9uW10gPSBmaWxlcy5yZWR1Y2UoKGFjY3VtLCBmaWxlKSA9PiB7XHJcbiAgICBjb25zdCBzZWdtZW50cyA9IGZpbGUuc3BsaXQocGF0aC5zZXApLmZpbHRlcihzZWcgPT4gISFzZWcpO1xyXG4gICAgaWYgKCFwYXRoLmV4dG5hbWUoc2VnbWVudHNbc2VnbWVudHMubGVuZ3RoIC0gMV0pKSB7XHJcbiAgICAgIC8vIFRoaXMgaXMgYSBkaXJlY3RvcnksIHdlIGRvbid0IG5lZWQgaXQuXHJcbiAgICAgIHJldHVybiBhY2N1bTtcclxuICAgIH1cclxuICAgIGNvbnN0IGRlc3RpbmF0aW9uID0gKHNlZ21lbnRzLmxlbmd0aCA+PSBtaW5TZWdJZHggKyAxKVxyXG4gICAgICA/IHNlZ21lbnRzLnNsaWNlKG1pblNlZ0lkeCkuam9pbihwYXRoLnNlcClcclxuICAgICAgOiB1bmRlZmluZWQ7XHJcbiAgICBpZiAoZGVzdGluYXRpb24gIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICBhY2N1bS5wdXNoKHtcclxuICAgICAgICB0eXBlOiAnY29weScsXHJcbiAgICAgICAgc291cmNlOiBmaWxlLFxyXG4gICAgICAgIGRlc3RpbmF0aW9uLFxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiBhY2N1bTtcclxuICB9LCBbXSk7XHJcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGluc3RydWN0aW9ucyB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHRlc3RDb3JlUmVtb3ZlcihmaWxlczogc3RyaW5nW10sIGdhbWVJZDogc3RyaW5nKTogUHJvbWlzZTx0eXBlcy5JU3VwcG9ydGVkUmVzdWx0PiB7XHJcbiAgaWYgKGdhbWVJZCAhPT0gR0FNRV9JRCkge1xyXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN1cHBvcnRlZDogZmFsc2UsIHJlcXVpcmVkRmlsZXM6IFtdIH0pO1xyXG4gIH1cclxuICBsZXQgc3VwcG9ydGVkID0gZmFsc2U7XHJcbiAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XHJcbiAgICBjb25zdCBzZWdtZW50cyA9IGZpbGUuc3BsaXQocGF0aC5zZXApLm1hcChzZWcgPT4gc2VnLnRvTG93ZXJDYXNlKCkpO1xyXG4gICAgaWYgKChzZWdtZW50cy5maW5kKHNlZyA9PiBpc0ludmFsaWRTZWdtZW50KHNlZywgSU5WQUxJRF9ESVJTKSkgIT09IHVuZGVmaW5lZClcclxuICAgICAgJiYgKGlzSW52YWxpZFNlZ21lbnQoc2VnbWVudHNbc2VnbWVudHMubGVuZ3RoIC0gMV0sIElOVkFMSURfRklMRVMpKSkge1xyXG4gICAgICAgIHN1cHBvcnRlZCA9IHRydWU7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN1cHBvcnRlZCwgcmVxdWlyZWRGaWxlczogW10gfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbnN0YWxsQ29yZVJlbW92ZXIoZmlsZXM6IHN0cmluZ1tdLCBkZXN0aW5hdGlvblBhdGg6IHN0cmluZywgZ2FtZUlkOiBzdHJpbmcpIHtcclxuICAvLyBNYW55IGV4aXN0aW5nIG1vZHMgaGF2ZSBCZXBJbkV4J3MgY29yZSBkaXJlY3RvcnkgcHJlLWluY2x1ZGVkLCB3ZSBkbyBub3Qgd2FudFxyXG4gIC8vICB0aG9zZSBmaWxlcyBpbnN0YWxsZWQgYXMgaXQgd2lsbCBqdXN0IGNhdXNlIHVuZXhwZWN0ZWQgYmVoYXZpb3VyLlxyXG4gIGxldCBtaW5TZWdJZHggPSAwO1xyXG4gIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xyXG4gICAgY29uc3Qgc2VnbWVudHMgPSBmaWxlLnNwbGl0KHBhdGguc2VwKVxyXG4gICAgICAuZmlsdGVyKHNlZyA9PiAhIXNlZylcclxuICAgICAgLm1hcChzZWcgPT4gc2VnLnRvTG93ZXJDYXNlKCkpO1xyXG5cclxuICAgIGlmIChzZWdtZW50cy5pbmNsdWRlcygncGx1Z2lucycpKSB7XHJcbiAgICAgIG1pblNlZ0lkeCA9IHNlZ21lbnRzLmluZGV4T2YoJ3BsdWdpbnMnKTtcclxuICAgICAgYnJlYWs7XHJcbiAgICB9XHJcbiAgICBpZiAoc2VnbWVudHMuaW5jbHVkZXMoJ3BhdGNoZXJzJykpIHtcclxuICAgICAgbWluU2VnSWR4ID0gc2VnbWVudHMuaW5kZXhPZigncGF0Y2hlcnMnKTtcclxuICAgICAgYnJlYWs7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdCBpbnN0cnVjdGlvbnM6IHR5cGVzLklJbnN0cnVjdGlvbltdID0gZmlsZXMucmVkdWNlKChhY2N1bSwgaXRlcikgPT4ge1xyXG4gICAgY29uc3Qgc2VnbWVudHMgPSBpdGVyLnNwbGl0KHBhdGguc2VwKS5maWx0ZXIoc2VnID0+ICEhc2VnKTtcclxuXHJcbiAgICBpZiAoIXNlZ21lbnRzLmZpbmQoc2VnID0+IGlzSW52YWxpZFNlZ21lbnQoc2VnLnRvTG93ZXJDYXNlKCksIElOVkFMSURfRElSUykpXHJcbiAgICAgICYmICghaXNJbnZhbGlkU2VnbWVudChzZWdtZW50c1tzZWdtZW50cy5sZW5ndGggLSAxXS50b0xvd2VyQ2FzZSgpLCBJTlZBTElEX0ZJTEVTKSlcclxuICAgICAgJiYgISFwYXRoLmV4dG5hbWUoc2VnbWVudHNbc2VnbWVudHMubGVuZ3RoIC0gMV0pKSB7XHJcbiAgICAgICAgY29uc3QgZGVzdGluYXRpb24gPSAoc2VnbWVudHMubGVuZ3RoID4gbWluU2VnSWR4ICsgMSlcclxuICAgICAgICAgID8gc2VnbWVudHMuc2xpY2UobWluU2VnSWR4KS5qb2luKHBhdGguc2VwKVxyXG4gICAgICAgICAgOiB1bmRlZmluZWQ7XHJcblxyXG4gICAgICAgIGlmIChkZXN0aW5hdGlvbiAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICBjb25zdCBpbnN0cjogdHlwZXMuSUluc3RydWN0aW9uID0ge1xyXG4gICAgICAgICAgICB0eXBlOiAnY29weScsXHJcbiAgICAgICAgICAgIHNvdXJjZTogaXRlcixcclxuICAgICAgICAgICAgZGVzdGluYXRpb24sXHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAgYWNjdW0ucHVzaChpbnN0cik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGFjY3VtO1xyXG4gIH0sIFtdKTtcclxuXHJcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGluc3RydWN0aW9ucyB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHRlc3RGdWxsUGFjayhmaWxlczogc3RyaW5nW10sIGdhbWVJZDogc3RyaW5nKTogUHJvbWlzZTx0eXBlcy5JU3VwcG9ydGVkUmVzdWx0PiB7XHJcbiAgaWYgKGdhbWVJZCAhPT0gR0FNRV9JRCkge1xyXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN1cHBvcnRlZDogZmFsc2UsIHJlcXVpcmVkRmlsZXM6IFtdIH0pO1xyXG4gIH1cclxuICBsZXQgc3VwcG9ydGVkID0gZmFsc2U7XHJcbiAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XHJcbiAgICBjb25zdCBzZWdtZW50cyA9IGZpbGUuc3BsaXQocGF0aC5zZXApLm1hcChzZWcgPT4gc2VnLnRvTG93ZXJDYXNlKCkpO1xyXG4gICAgY29uc3QgY29yZUxpYklkeCA9IGluZGV4T2ZQYWNrU2VnbWVudChzZWdtZW50cyk7XHJcbiAgICBpZiAoY29yZUxpYklkeCA9PT0gLTEpIHtcclxuICAgICAgY29udGludWU7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGNvcmVMaWJJZHggIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICBzdXBwb3J0ZWQgPSB0cnVlO1xyXG4gICAgICBicmVhaztcclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN1cHBvcnRlZCwgcmVxdWlyZWRGaWxlczogW10gfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbnN0YWxsRnVsbFBhY2soZmlsZXM6IHN0cmluZ1tdLCBkZXN0aW5hdGlvblBhdGg6IHN0cmluZywgZ2FtZUlkOiBzdHJpbmcpIHtcclxuICBsZXQgY29yZUxpYklkeCA9IC0xO1xyXG4gIGxldCBwYWNrVHlwZTogUGFja1R5cGU7XHJcbiAgY29uc3QgZmlsdGVyZWQgPSBmaWxlcy5maWx0ZXIoZmlsZSA9PiB7XHJcbiAgICBjb25zdCBzZWdtZW50cyA9IGZpbGUuc3BsaXQocGF0aC5zZXApLm1hcChzZWcgPT4gc2VnLnRvTG93ZXJDYXNlKCkpO1xyXG4gICAgaWYgKCFwYXRoLmV4dG5hbWUoc2VnbWVudHNbc2VnbWVudHMubGVuZ3RoIC0gMV0pKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGlmIChjb3JlTGliSWR4ID09PSAtMSkge1xyXG4gICAgICBjb3JlTGliSWR4ID0gaW5kZXhPZlBhY2tTZWdtZW50KHNlZ21lbnRzKTtcclxuICAgICAgcGFja1R5cGUgPSBnZXRQYWNrVHlwZShzZWdtZW50c1tjb3JlTGliSWR4XSk7XHJcbiAgICAgIGlmIChjb3JlTGliSWR4ICE9PSAtMSkge1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAoUEFDS19TRUdNRU5UUy5pbmNsdWRlcyhzZWdtZW50c1tjb3JlTGliSWR4XSkpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH0pO1xyXG5cclxuICBpZiAocGFja1R5cGUgPT09ICdub25lJykge1xyXG4gICAgLy8gSG93IGRpZCB3ZSBnZXQgaGVyZSBpZiB0aGlzIGlzbid0IGFuIHVuc3RyaXBwZWQgYXNzZW1ibGllcyBwYWNrYWdlP1xyXG4gICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyB1dGlsLk5vdFN1cHBvcnRlZEVycm9yKCkpO1xyXG4gIH1cclxuICBjb25zdCBtb2RUeXBlSW5zdHI6IHR5cGVzLklJbnN0cnVjdGlvbiA9IChwYWNrVHlwZSA9PT0gJ2NvcmVfbGliJylcclxuICAgID8ge1xyXG4gICAgICB0eXBlOiAnc2V0bW9kdHlwZScsXHJcbiAgICAgIHZhbHVlOiAnYmVwaW5leC1yb290LW1vZCcsXHJcbiAgICB9IDoge1xyXG4gICAgICB0eXBlOiAnc2V0bW9kdHlwZScsXHJcbiAgICAgIHZhbHVlOiAndW5zdHJpcHBlZC1hc3NlbWJsaWVzJyxcclxuICAgIH07XHJcblxyXG4gIGNvbnN0IG1vZEF0dHJpYkluc3RyOiB0eXBlcy5JSW5zdHJ1Y3Rpb24gPSB7XHJcbiAgICB0eXBlOiAnYXR0cmlidXRlJyxcclxuICAgIGtleTogJ0NvcmVMaWJUeXBlJyxcclxuICAgIHZhbHVlOiBwYWNrVHlwZSxcclxuICB9O1xyXG4gIGNvbnN0IGluc3RydWN0aW9uczogdHlwZXMuSUluc3RydWN0aW9uW10gPSBbbW9kVHlwZUluc3RyLCBtb2RBdHRyaWJJbnN0cl1cclxuICAgIC5jb25jYXQoZmlsdGVyZWQubWFwKGZpbGUgPT4gKHtcclxuICAgICAgdHlwZTogJ2NvcHknLFxyXG4gICAgICBzb3VyY2U6IGZpbGUsXHJcbiAgICAgIGRlc3RpbmF0aW9uOiBmaWxlLnNwbGl0KHBhdGguc2VwKS5zbGljZShjb3JlTGliSWR4KS5qb2luKHBhdGguc2VwKSxcclxuICB9KSkpO1xyXG5cclxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgaW5zdHJ1Y3Rpb25zIH0pO1xyXG59XHJcbiJdfQ==